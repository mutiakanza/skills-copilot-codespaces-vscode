// Prisma schema for University Learning Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  STUDENT
  LECTURER
  ADMIN
}

enum AssignmentStatus {
  SUBMITTED
  GRADED
  PUBLISHED
}

enum QuizQuestionType {
  MULTIPLE_CHOICE
  FILL_IN
  DRAG_DROP
}

// User Model
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String
  role          UserRole @default(STUDENT)
  ssoId         String?  @unique
  passwordHash  String?
  locale        String   @default("id")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  enrollments   Enrollment[]
  submissions   Assignment[]
  quizAttempts  QuizAttempt[]
  gradings      Grading[]
  coursesCreated Course[] @relation("CourseInstructor")
  
  @@map("users")
}

// Course Model
model Course {
  id          String   @id @default(uuid())
  title       String
  description String?
  enrollKey   String?
  startDate   DateTime?
  endDate     DateTime?
  instructorId String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  instructor  User @relation("CourseInstructor", fields: [instructorId], references: [id])
  materials   Material[]
  enrollments Enrollment[]
  quizzes     Quiz[]
  
  @@map("courses")
}

// Material Model
model Material {
  id          String   @id @default(uuid())
  courseId    String
  title       String
  description String?
  type        String   // video, pdf, text
  fileUrl     String?
  content     String?  @db.Text
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course      Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@map("materials")
}

// Enrollment Model
model Enrollment {
  id          String   @id @default(uuid())
  userId      String
  courseId    String
  progress    Float    @default(0)
  enrolledAt  DateTime @default(now())

  // Relations
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  course      Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, courseId])
  @@map("enrollments")
}

// Quiz Model
model Quiz {
  id          String   @id @default(uuid())
  courseId    String
  title       String
  description String?
  timeLimit   Int?     // in minutes
  passingScore Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course      Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions   QuizQuestion[]
  attempts    QuizAttempt[]
  
  @@map("quizzes")
}

// Quiz Question Model
model QuizQuestion {
  id          String   @id @default(uuid())
  quizId      String
  type        QuizQuestionType
  question    String   @db.Text
  options     Json?    // For MCQ: array of options
  correctAnswer String?
  weight      Float    @default(1)
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  // Relations
  quiz        Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  @@map("quiz_questions")
}

// Quiz Attempt Model
model QuizAttempt {
  id          String   @id @default(uuid())
  quizId      String
  userId      String
  answers     Json     // Store user answers
  score       Float?
  startedAt   DateTime @default(now())
  submittedAt DateTime?

  // Relations
  quiz        Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("quiz_attempts")
}

// Assignment Model
model Assignment {
  id          String   @id @default(uuid())
  courseId    String
  userId      String
  title       String
  description String?  @db.Text
  fileUrl     String?
  status      AssignmentStatus @default(SUBMITTED)
  submittedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  grading     Grading?
  
  @@map("assignments")
}

// Grading Model
model Grading {
  id          String   @id @default(uuid())
  assignmentId String  @unique
  gradedBy    String
  score       Float
  feedback    String?  @db.Text
  rubric      Json?
  gradedAt    DateTime @default(now())

  // Relations
  assignment  Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  grader      User @relation(fields: [gradedBy], references: [id])
  
  @@map("gradings")
}
